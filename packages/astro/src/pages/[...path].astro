---
import { type DirectoryEntry, getDirectoryEntries } from "@packages/common";
import Entry from "../components/Entry.astro";
import UploadButton from "../components/UploadButton.astro";

const dirPath: string = Astro.params.path ?? '';
let files: DirectoryEntry[] | null = null;
let parentDir: string | null = null;

try {
    files = await getDirectoryEntries(dirPath);
    const pathDirs = dirPath.split("/");
    const length = pathDirs.length;
    if (length > 0 && pathDirs[0].length > 0) {
        parentDir = "/" + pathDirs.slice(0, length - 1).join("/");
    }
} catch (e) {
    console.error(e)
}

if (files == null) {
    Astro.response.status = 404;
}
---

<!DOCTYPE html>
<html lang=ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SimpleCDN</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  <center>
    <h1>CDN File list</h1>
    <hr>
    {(files == null) && <p>404 Not Found</p>}
    <UploadButton>アップロード(ログインが必要です)</UploadButton>
  </center>
  <ul id="files">
    {(parentDir != null) && <Entry name=".." href={parentDir} />}
    {files?.map((file) =>
        <Entry name={file.name} href={file.name} size={file.directory ? "ディレクトリ" : file.sizeStr} />
    )}
  </ul>
</body>

</html>