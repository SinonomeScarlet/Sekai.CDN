---
import { type DirectoryEntry, getDirectoryEntries } from "@packages/common";
import Entry from "../components/Entry.astro";
import Layout from "../layouts/Layout.astro";
import List from "../components/List.astro";
import Header from "../components/Header.astro";

const dirPath: string = Astro.params.path ?? '';
let files: DirectoryEntry[] | null = null;
let parentDir: string | null = null;

try {
    files = await getDirectoryEntries(dirPath);
    const pathDirs = dirPath.split("/");
    const length = pathDirs.length;
    if (length > 0 && pathDirs[0].length > 0) {
        parentDir = "/" + pathDirs.slice(0, length - 1).join("/");
    }
} catch (e) {
    console.error(e)
}

if (files == null) {
    Astro.response.status = 404;
}
---

<Layout>
  <Header found={files != null} />
  <List>
    {(parentDir != null) && <Entry name=".." href={parentDir} type="parent" />}
    {files?.map((file) =>
        <Entry
          name={file.name}
          href={file.name}
          size={file.directory ? "ディレクトリ" : file.sizeStr}
          type={file.directory ? "directory" : "file"} />
    )}
  </List>
</Layout>
